{"version":3,"sources":["../../../src/services/user.service.ts"],"sourcesContent":["import { hash } from 'bcrypt';\nimport { Service } from 'typedi';\nimport { HttpException } from '@/exceptions/HttpException';\nimport { User } from '@prisma/client';\nimport { BaseService } from '@/services/base/base.service';\nimport bcrypt from 'bcryptjs';\n\n/**\n * Service class for handling user-related operations.\n * Extends the base service for CRUD functionality specific to the User model.\n */\n@Service()\nexport class UserService extends BaseService<User> {\n  /**\n   * Constructor initializes the base service with the 'User' model name.\n   */\n  constructor() {\n    super('User');\n  }\n\n  public query = this.prisma.user;\n\n  /**\n   * Retrieves all users from the database.\n   * @returns {Promise<User[]>} - A promise that resolves to an array of users.\n   */\n  public async findAll(): Promise<User[]> {\n    return this.prisma.user.findMany();\n  }\n\n  /**\n   * Finds a user by their unique ID.\n   * @param {string} userId - The ID of the user to find.\n   * @returns {Promise<User>} - A promise that resolves to the found user or throws an exception if not found.\n   * @throws {HttpException} - Throws an exception if the user does not exist.\n   */\n  public async findById(userId: string): Promise<User> {\n    const findUser: User = await this.prisma.user.findUnique({\n      where: { id: userId },\n    });\n    if (!findUser) throw new HttpException(409, \"User doesn't exist\");\n\n    return findUser;\n  }\n\n  /**\n   * Creates a new user with the provided data.\n   * Hashes the password before saving the user in the database.\n   * @param {User} data - The user data to create.\n   * @returns {Promise<User>} - A promise that resolves to the created user.\n   * @throws {HttpException} - Throws an exception if the email already exists.\n   */\n  public async create(data: User): Promise<User> {\n    // Check if user already exists by email\n    const findUser: User = await this.prisma.user.findUnique({\n      where: { email: data.email },\n    });\n    if (findUser) throw new HttpException(409, `This email ${data.email} already exists`);\n\n    // Hash the user's password\n    const hashedPassword = await hash(data.password, 10);\n\n    // Create the user with the hashed password\n    delete data.id;\n    return this.prisma.user.create({\n      data: { ...data, password: hashedPassword },\n    });\n  }\n  /**\n   * Updates an existing user by their ID with the provided data.\n   * If the password is updated, it is hashed before saving.\n   * Validates that the email is unique across users.\n   * @param {string} userId - The ID of the user to update.\n   * @param {User} data - The new data for the user.\n   * @returns {Promise<User>} - A promise that resolves to the updated user.\n   * @throws {HttpException} - Throws an exception if the email already exists for a different user.\n   * @throws {HttpException} - Throws an exception if the user with the provided ID is not found.\n   */\n  public async update(userId: string, data: User): Promise<User> {\n    // Find the user by ID to ensure the user exists\n    const findUser: User | null = await this.prisma.user.findUnique({\n      where: { id: userId },\n    });\n\n    // Throw an error if unable to find user with userId\n    if (!findUser) {\n      throw new HttpException(404, `User with ID ${userId} not found`);\n    }\n\n    // Check if another user exists with the same email but a different ID\n    if (data.email && data.email.toLowerCase() !== findUser.email.toLowerCase()) {\n      const existingUserWithEmail: User | null = await this.prisma.user.findUnique({\n        where: { email: data.email },\n      });\n\n      // Throw an error if an existing user with the same email is found\n      if (existingUserWithEmail) {\n        throw new HttpException(409, `Email ${data.email} is already in use by another user`);\n      }\n    }\n\n    // Hash the new password if provided\n    if (data.password) {\n      const hashedPassword = await hash(data.password, 10);\n      data = { ...data, password: hashedPassword };\n    }\n\n    // Update the user with new data\n    return this.prisma.user.update({\n      where: { id: userId },\n      data: data,\n    });\n  }\n\n  /**\n   * Deletes users by their IDs.\n   * @param {string[]} userIds - An array of user IDs to delete.\n   * @returns {Promise<boolean>} - A promise that resolves to true if users were successfully deleted.\n   * @throws {HttpException} - Throws an exception if no users were deleted.\n   */\n  public async delete(userIds: string[]): Promise<boolean> {\n    // Attempt to delete users with the provided IDs\n    const result = await this.prisma.user.deleteMany({\n      where: {\n        id: { in: userIds },\n      },\n    });\n\n    // Throw an error if no users were deleted\n    if (!result.count) throw new HttpException(409, \"User doesn't exist\");\n\n    return true;\n  }\n\n  public async updatePasswordWithoutCurrent(userId: string, newPassword: string): Promise<void> {\n    const admin = await this.prisma.user.findUnique({ where: { id: userId } });\n\n    if (!admin) {\n      throw new Error('Admin not found');\n    }\n\n    const isNewMatch = await bcrypt.compare(newPassword, admin.password);\n    if (isNewMatch) {\n      throw new Error('New password is already used in the past');\n    }\n\n    const hashedPassword = await bcrypt.hash(newPassword, 10);\n\n    await this.prisma.user.update({\n      where: { id: userId },\n      data: { password: hashedPassword },\n    });\n  }\n}\n"],"names":["UserService","BaseService","findAll","prisma","user","findMany","findById","userId","findUser","findUnique","where","id","HttpException","create","data","email","hashedPassword","hash","password","update","toLowerCase","existingUserWithEmail","delete","userIds","result","deleteMany","in","count","updatePasswordWithoutCurrent","newPassword","admin","Error","isNewMatch","bcrypt","compare","constructor","query"],"mappings":"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"}